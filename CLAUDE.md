# English Trainer — Instructions

## Product Document
All design and development decisions MUST align with [PRODUCT.md](PRODUCT.md). Before implementing any feature, check the product document for:
- Core mechanics (Section 3)
- Current stage scope and what's in/out of scope (Section 4)
- User flow and state machine (Section 8)
- Tech stack (Section 6)
- Data model (Section 9)

## Tech Stack
- **Runtime:** Node.js + TypeScript
- **Bot framework:** grammY (TS-first Telegram bot framework)
- **Database:** SQLite + Prisma ORM
- **AI:** OpenAI API (GPT)
- **Dev mode:** long polling (no web server needed)

## Key Principles
- Keep it simple — MVP first, no over-engineering
- Telegram-native UX: reply keyboards for navigation, inline buttons for context actions
- State machine architecture for bot dialog flow
- All content generated by LLM, personalized per user
- Free text interpreted by current state context, not LLM-routing (for MVP)

## Language
- Code, comments, variable names — in English
- User-facing bot messages — in Russian (primary) and English (for exercises)
- Documentation — Russian or English depending on context

## Project Structure

```
/src
  ├── bot.ts              # grammY bot entry point, command handlers, message routing
  ├── state.ts            # User state & profile management (DB operations)
  ├── constants.ts        # Hardcoded strings
  └── /llm                # LLM integrations (OpenAI, Gemini)
      ├── index.ts        # Factory function createLLM()
      ├── openai.ts       # OpenAI client
      ├── gemini.ts       # Google Gemini client
      └── types.ts        # Shared LLM interfaces

/prisma
  ├── schema.prisma       # Data models: TestUserState, TestUserProfile
  └── /migrations         # Database migrations

/directives              # Agent directives registry
  ├── 00-agent-protocol.md    # Core work cycle
  ├── 10-runtime.md           # Dev mode & restart rules
  ├── 20-db-prisma.md         # Database & schema changes
  ├── 30-telegram.md          # grammY & bot behavior
  ├── 40-llm.md               # LLM providers & prompting
  ├── 50-git-quality.md       # Git & code quality
  └── 90-definition-of-done.md # Task completion checklist

Root
  ├── package.json        # Dependencies & scripts (dev, build, start, start:studio)
  ├── tsconfig.json       # TypeScript config
  ├── prisma.config.ts    # Prisma config (better-sqlite3)
  ├── .env               # Environment variables (BOT_TOKEN, API keys)
  └── PRODUCT.md         # Product document (source of truth)
```

### Key Files
- **`bot.ts`** — Handles /start, /debug commands; routes messages by user state (ONBOARDING → parse with LLM → MAIN_MENU)
- **`state.ts`** — DB layer for user state & profile persistence
- **Data Models** — TestUserState (id, state), TestUserProfile (id, level, goals, interests, rawResponse)

## Following Directives
See `/directives` folder for detailed guidelines by topic:
- **00-agent-protocol.md** — Core work cycle, no guessing, keep diffs small
- **10-runtime.md** — Dev mode, restart server, build checks
- **20-db-prisma.md** — Schema changes, migrations, data models
- **30-telegram.md** — grammY framework, message routing, keyboards
- **40-llm.md** — LLM providers, prompting, API usage
- **50-git-quality.md** — Git workflow, commit format, code quality
- **90-definition-of-done.md** — Task completion checklist

